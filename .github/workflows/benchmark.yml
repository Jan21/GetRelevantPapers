name: Performance Benchmarks

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.py'
      - 'requirements.txt'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  benchmark:
    name: Run Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest-benchmark memory-profiler

    - name: Create test data
      run: |
        mkdir -p test_papers converted_papers
        echo "# Test Paper" > test_papers/test1.md
        echo "This is a test paper for benchmarking." >> test_papers/test1.md
        echo "## Methods" >> test_papers/test1.md
        echo "We used deep learning methods." >> test_papers/test1.md

    - name: Test analyzer performance
      run: |
        python -c "
        import time
        from analyzer import PaperAnalyzer
        
        start = time.time()
        analyzer = PaperAnalyzer()
        elapsed = time.time() - start
        print(f'Analyzer initialization: {elapsed:.3f}s')
        
        if elapsed > 5.0:
            print('WARNING: Slow initialization detected')
        "
      continue-on-error: true

    - name: Test vector store performance
      run: |
        python -c "
        import time
        import os
        
        os.makedirs('vector_store', exist_ok=True)
        
        try:
            from vector_store import VectorStore
            start = time.time()
            vs = VectorStore()
            elapsed = time.time() - start
            print(f'VectorStore initialization: {elapsed:.3f}s')
        except Exception as e:
            print(f'VectorStore test skipped: {e}')
        "
      continue-on-error: true

    - name: Memory usage check
      run: |
        python -m memory_profiler -m pytest --verbose || echo "Memory profiling completed"
      continue-on-error: true

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: benchmark-results
        path: |
          .benchmarks/
          *.prof
        retention-days: 30

