name: CI Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Test Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run pytest
      run: |
        pytest --verbose --color=yes || echo "No tests found or tests failed"
      continue-on-error: true

    - name: Check Python syntax
      run: |
        python -m py_compile *.py
        find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" -not -path "./outputs/*" -not -path "./sample_papers/*" -not -path "./downloaded_papers/*" | xargs python -m py_compile

  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 pylint mypy

    - name: Run Black formatter check
      run: |
        black --check --diff . || echo "Black formatting issues found (non-blocking)"
      continue-on-error: true

    - name: Run Flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv,.venv,outputs,sample_papers,downloaded_papers,__pycache__
        # Exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=venv,.venv,outputs,sample_papers,downloaded_papers,__pycache__
      continue-on-error: true

    - name: Run Pylint
      run: |
        pylint --exit-zero --max-line-length=127 --disable=C0114,C0115,C0116 *.py classifiers/*.py || echo "Pylint check completed"
      continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install safety
      run: |
        python -m pip install --upgrade pip
        pip install safety bandit

    - name: Check dependencies for vulnerabilities
      run: |
        pip install -r requirements.txt
        safety check || echo "Security vulnerabilities found (non-blocking)"
      continue-on-error: true

    - name: Run Bandit security linter
      run: |
        bandit -r . -x ./venv,./outputs,./sample_papers,./downloaded_papers || echo "Bandit security issues found (non-blocking)"
      continue-on-error: true

  dependency-check:
    name: Dependency Validation
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Validate requirements.txt
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt --dry-run || exit 1

    - name: Check for dependency conflicts
      run: |
        pip install -r requirements.txt
        pip check

  build-check:
    name: Build & Import Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Test imports
      run: |
        python -c "import analyzer; print('✓ analyzer imported')"
        python -c "import llm_evaluator; print('✓ llm_evaluator imported')" || echo "llm_evaluator import failed (may require AWS credentials)"
        python -c "import bedrock_evaluator; print('✓ bedrock_evaluator imported')" || echo "bedrock_evaluator import failed (may require AWS credentials)"
        python -c "import vector_store; print('✓ vector_store imported')"
        python -c "import markdown_parser; print('✓ markdown_parser imported')"
        python -c "from classifiers.base_classifier import BaseClassifier; print('✓ classifiers package imported')"
      continue-on-error: true

    - name: Create necessary directories
      run: |
        mkdir -p markdown_db/raw markdown_db/sections vector_store converted_papers outputs

    - name: Verify project structure
      run: |
        echo "Checking project structure..."
        ls -la
        echo "✓ Project structure verified"

